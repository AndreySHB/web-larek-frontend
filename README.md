# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

### 1. Архитектура проекта (MVC / Component-Based Architecture)

Архитектура проекта следует паттерну, близкому к **Model-View-Controller (MVC)**, с ярко выраженным **событийным (Event-Driven)** взаимодействием между частями. Её можно разделить на четыре основных слоя:

1.  **Модели (Models):** Классы, отвечающие за данные и бизнес-логику приложения (`AppState`, `BasketModel`, `Product`).
2.  **Представления (Views):** Классы, отвечающие за отображение данных пользователю и взаимодействие с ним (`Page`, `Modal`, `Card`, `BasketView`, `BaseForm` и его наследники).
3.  **Сервисы (Services):** Классы для взаимодействия с внешним API (`ShopAPI`).
4.  **Ядро (Core):** Базовые классы, обеспечивающие работу всей архитектуры (`EventEmitter`, `Model`, `View`, `Api`).

**Взаимодействие частей:** Все компоненты общаются друг с другом **через события (EventEmitter)**. Модель не знает о View, а View не знает о Model. Когда модель меняется, она испускает событие (например, `'items:changed'`). View, подписанные на это событие, реагируют на него и обновляют свой интерфейс. Аналогично, пользовательское взаимодействие с View (клик, ввод) также порождает события, на которые реагируют другие View или Модели.

---

### 2. Описание базовых классов (Ядро)

#### **Класс `EventEmitter` (`/src/components/base/events.ts`)**
*   **Предназначение:** Реализует паттерн "Наблюдатель" (Publisher-Subscriber). Является центральным брокером событий для всего приложения. Обеспечивает слабую связность между компонентами.
*   **Функции:**
    *   `on(event, callback)`: Подписаться на событие. Событием может быть строка или RegExp.
    *   `off(event, callback)`: Отписаться от события.
    *   `emit(event, data?)`: Инициировать событие, уведомив всех подписчиков.
    *   `onAll(callback)`: Подписаться на все события (удобно для отладки).
    *   `trigger(event, context)`: Создать функцию-колбэк, которая при вызове генерирует указанное событие.

#### **Класс `Model<T>` (`/src/components/base/Model.ts`)**
*   **Предназначение:** Абстрактный базовый класс для всех моделей данных. Нужен, чтобы отличать модели от простых объектов и предоставлять общий метод для уведомления об изменениях.
*   **Функции:**
    *   `emitChanges(event, payload?)`: Сообщить системе о изменении состояния модели, вызвав событие через `EventEmitter`.

#### **Класс `View<T>` (`/src/components/base/View.ts`)**
*   **Предназначение:** Абстрактный базовый класс для всех компонентов представления. Инкапсулирует общие методы для работы с DOM.
*   **Функции:**
    *   Вспомогательные методы: `toggleClass`, `setText`, `setDisabled`, `setHidden`, `setVisible`, `setImage`.
    *   `render(data?)`: Основной метод для обновления состояния компонента и возврата корневого DOM-элемента.

#### **Класс `Api` (`/src/components/base/api.ts`)**
*   **Предназначение:** Обёртка для работы с `fetch`. Предоставляет единообразные методы для HTTP-запросов.
*   **Функции:**
    *   `get(uri)`: Выполнить GET-запрос.
    *   `post(uri, data, method)`: Выполнить POST, PUT или DELETE запрос.
    *   `handleResponse(response)`: Обработать ответ сервера, преобразовать в JSON или выбросить ошибку.

---

### 3. Описание компонентов

#### **Данные (Models)**

1.  **`Product` (`/src/components/model/Product.ts`)**
    *   **Предназначение:** Модель товара. Реализует методы `equals` и `hashCode` для корректной работы с коллекциями (например,作为 ключа в `Map` внутри корзины).
    *   **Данные:** `id`, `title`, `description`, `image`, `category`, `price`.

2.  **`AppState` (`/src/components/model/AppState.ts`)**
    *   **Предназначение:** Главная модель состояния приложения. Хранит каталог товаров, данные текущего заказа и ошибки валидации форм.
    *   **Функции:**
        *   `setCatalog(items)`: Заполнить каталог товаров (преобразует массив в `Map` для быстрого поиска по id).
        *   `setPreview(item)`: Установить товар для просмотра в модальном окне.
        *   `setPhoneEmailField`/`setAddressField`: Установить значение поля заказа и запустить валидацию.
        *   `validatePhoneEmail()`/`validateAddress()`: Валидация данных формы, генерация ошибок и соответствующих событий.

3.  **`BasketModel` (`/src/components/model/BasketModel.ts`)**
*   **Предназначение:** Модель корзины покупок. Хранит товары и их количество.
*   **Функции:**
    *   `add(product)`, `remove(product)`: Добавить/удалить товар.
    *   `getTotalItems()`, `getTotalPrice()`: Рассчитать общее количество товаров и итоговую стоимость.
    *   `getFlatItems()`: Преобразовать содержимое корзины в плоский массив id товаров (для отправки на сервер).
    *   `clear()`: Очистить корзину.

#### **Представления (Views)**

1.  **`Page` (`/src/components/view/Page.ts`)**
    *   **Предназначение:** Главный компонент страницы. Управляет отображением каталога товаров и кнопкой корзины.
    *   **Функции:** `set catalog`, `set basketCount`, `lock()`/`unlock()` (блокировка страницы при открытии модального окна).

2.  **`Modal` (`/src/components/view/Modal.ts`)**
    *   **Предназначение:** Базовая модальное окно. Управляет открытием, закрытием и отображением контента внутри себя.
    *   **Функции:** `open()`, `close()`, `set content`.

3.  **`Card` (и её наследники `CatalogCard`, `PreviewCard`, `BasketCard`) (`/src/components/view/Card.ts`)**
    *   **Предназначение:** Компоненты для отображения товара в разных контекстах (в каталоге, в превью, в корзине). Наследуются от `BaseCard`, который, в свою очередь, наследуется от `View`.
    *   **`CatalogCard`:** Отображает основную информацию для списка.
    *   **`PreviewCard`:** Отображает полную информацию о товаре и кнопку "В корзину".
    *   **`BasketCard`:** Отображает товар в корзине с количеством и кнопкой удаления.

4.  **`BasketView` (`/src/components/view/BasketView.ts`)**
    *   **Предназначение:** Представление всей корзины. Содержит список товаров (`BasketCard`), итоговую стоимость и кнопку оформления заказа.

5.  **`BaseForm<T>` (`/src/components/view/BaseForm.ts`)**
    *   **Предназначение:** Абстрактный базовый класс для форм. Обрабатывает ввод данных и отправку формы, генерируя события.
    *   **Функции:**
        *   Генерирует события вида `formName.fieldName:change` при вводе данных.
        *   Генерирует событие `formName:submit` при отправке формы.
        *   Управляет состоянием кнопки отправки и блоком ошибок.

6.  **`OrderAddressForm` (`/src/components/view/OrderAddressForm.ts`)**
    *   **Наследник `BaseForm`.** Форма для выбора способа оплаты и ввода адреса.

7.  **`OrderContactForm` (`/src/components/view/OrderContactForm.ts`)**
    *   **Наследник `BaseForm`.** Форма для ввода email и телефона.

8.  **`FinishModal` (`/src/components/view/FinishModal.ts`)**
    *   **Предназначение:** Модальное окно, отображающее результат успешного оформления заказа.

#### **Сервисы (Services)**

1.  **`ShopAPI` (`/src/components/ShopApi.ts`)**
    *   **Предназначение:** Слой для взаимодействия с бэкендом.
    *   **Функции:**
        *   `getProducts()`: Загружает список товаров, подменяя URL изображений на CDN.
        *   `order(data)`: Отправляет данные заказа на сервер.

---

### 4. Данные приложения (Types)

Интерфейсы описаны в `/src/types/index.ts`:
*   **`IProduct`:** Структура данных товара.
*   **`IAppState`, `IBasket`:** Интерфейсы для соответствующих моделей.
*   **`IEmailPhoneOrderForm`, `IAddressOrderForm`:** Данные для двух шагов оформления заказа.
*   **`FormErrors...`:** Типы для объектов с ошибками валидации.
*   **`PaymentData`:** Структура данных для отправки заказа на сервер (`items` - массив id товаров).
*   **`IOrderResult`:** Ответ сервера на успешный заказ (содержит `id` заказа).

---

### 5. Процессы в приложении

Процессы реализованы **исключительно через события**. В файле `index.ts` создаются экземпляры всех компонентов и настраивается их взаимодействие через подписку на события `EventEmitter`.

**Пример процесса "Добавление товара в корзину":**
1.  Пользователь кликает на товар в каталоге -> `CatalogCard` генерирует событие `'card:select'`.
2.  `AppState` ловит это событие и вызывает `setPreview(item)`, что генерирует событие `'preview:changed'`.
3.  Модальное окно ловит `'preview:changed'`, создает `PreviewCard` и открывается.
4.  Пользователь кликает "В корзину" в модальном окне -> `PreviewCard` вызывает `basket.add(item)`.
5.  `BasketModel.add()` генерирует событие `'basket:change'`.
6.  `Page` ловит `'basket:change'` и обновляет счетчик на иконке корзины.

**Пример процесса "Оформление заказа":**
Это длинная цепочка событий: `'basket:open'` -> `'order:start'` (открытие формы адреса) -> `'order:contacts'` (переход к форме контактов) -> `'order:pay'` (отправка данных на сервер) -> `'order:finish'` (показ финального окна). На каждом шаге данные валидируются, и события валидации (`'formErrors...:change'`) управляют активностью кнопок.

---

### 6. UML-схема (текстовое описание)

Вот упрощенное описание структуры:

```
[ShopAPI] <-(запросы)-> [Backend]
    ^
    |
    | (получает данные)
    |
[AppState] --(has a)--> [BasketModel]
    |                      |
    | (изменяет состояние) | (изменяет состояние)
    | (генерирует события) | (генерирует события)
    V                      V
[EventEmitter] <---(is the core)---+
    ^                              |
    |                              |
(подписываются и генерируют события)
    |                              |
    V                              V
[Page] [Modal] [BasketView] [OrderAddressForm] [OrderContactForm] ...
    |       |        |           |                 |
    |       |        |           |                 |
    |       |        |(contains) |                 |
    |       |        V           |                 |
    |       |  [BasketCard]      |                 |
    |       |                    |                 |
    |       |(shows)             |                 |
    |       V                    V                 V
    |  [CatalogCard][PreviewCard]             (User Input)
    |       |
    |       |
    V       V
(Browser DOM)
```

**Центром схемы является `EventEmitter`**. Все стрелки (взаимодействия) между компонентами проходят через него в виде событий, что делает архитектуру очень гибкой и декомпонованной.